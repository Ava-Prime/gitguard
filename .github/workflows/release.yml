name: release

on:
  push:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write            # create tags/releases
  pull-requests: write       # open/approve release PRs
  packages: write            # push GHCR
  id-token: write            # keyless cosign

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Phase A: open/refresh the Release PR when commits hit main
  release-please:
    if: github.event_name != 'release'
    runs-on: ubuntu-latest
    steps:
      - uses: google-github-actions/release-please-action@e4dc86ba9405554aeba3c6bb2d169500e7d3b4ee # v4.1.1
        with:
          command: manifest

  # Phase B: after the PR is merged and the GitHub Release is published,
  # build multi-arch image, sign, attest, and publish to GHCR.
  build-publish:
    if: github.event_name == 'release' && github.event.action == 'published'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@988b5a0280414f521da01fcc63a27aeeb4b104db # v3.6.1

      - name: Log in to GHCR
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push (multi-arch)
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/${{ github.repository_owner }}/gitguard:${{ github.event.release.tag_name }}
            ghcr.io/${{ github.repository_owner }}/gitguard:latest
          provenance: true
          sbom: true

      - name: Install Cosign
        uses: sigstore/cosign-installer@4959ce089c160fddf62f7b42464195ba1a56d382 # v3.6.0

      - name: Cosign keyless sign & verify
        run: |
          cosign sign ghcr.io/${{ github.repository_owner }}/gitguard:${{ github.event.release.tag_name }} \
            --yes
